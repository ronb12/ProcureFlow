rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function getUserOrgId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId;
    }
    
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    function isApprover() {
      return isSignedIn() && getUserRole() in ['approver', 'admin'];
    }
    
    function isCardholder() {
      return isSignedIn() && getUserRole() in ['cardholder', 'admin'];
    }
    
    function isAuditor() {
      return isSignedIn() && getUserRole() in ['auditor', 'admin'];
    }
    
    function isRequester() {
      return isSignedIn() && getUserRole() in ['requester', 'admin'];
    }
    
    function isSameOrg(orgId) {
      return isSignedIn() && getUserOrgId() == orgId;
    }
    
    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    function isValidStatusTransition(from, to) {
      let validTransitions = {
        'Draft': ['Submitted'],
        'Submitted': ['AO Review'],
        'AO Review': ['Approved', 'Denied', 'Returned'],
        'Approved': ['Cardholder Purchasing'],
        'Cardholder Purchasing': ['Purchased'],
        'Purchased': ['Reconciled'],
        'Reconciled': ['Closed'],
        'Returned': ['Draft', 'Submitted'],
        'Denied': [],
        'Closed': []
      };
      return to in validTransitions[from];
    }
    
    function canEditRequest(status) {
      return status in ['Draft', 'Returned'];
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Organizations collection
    match /orgs/{orgId} {
      allow read: if isSignedIn() && (isSameOrg(orgId) || isAdmin());
      allow write: if isAdmin();
    }
    
    // Global settings
    match /settings/global {
      allow read: if isAdmin() || isApprover() || isCardholder();
      allow write: if isAdmin();
    }
    
    // Requests collection
    match /requests/{requestId} {
      allow create: if isRequester(); // Only requesters and admins can create requests
      allow read: if isSignedIn();
      allow update: if isSignedIn() && (
        // Requester can edit only in Draft/Returned
        (resource.data.requesterId == request.auth.uid && canEditRequest(resource.data.status)) ||
        // Approver can update during AO Review
        (isApprover() && resource.data.status == 'AO Review') ||
        // Cardholder can update during Cardholder Purchasing
        (isCardholder() && resource.data.status == 'Cardholder Purchasing') ||
        // Admin can update anything
        isAdmin()
      );
      allow delete: if isAdmin() && resource.data.status in ['Draft', 'Returned'];
      
      // Items subcollection
      match /items/{itemId} {
        allow read, write: if isSignedIn();
      }
    }
    
    // Approvals collection
    match /approvals/{approvalId} {
      allow create, read: if isApprover() || isAdmin();
    }
    
    // Purchases collection
    match /purchases/{purchaseId} {
      allow create, read, update: if isCardholder() || isAdmin();
    }
    
    // Purchase Orders collection
    match /purchaseOrders/{poId} {
      allow create: if isSignedIn(); // Server-side functions can create
      allow read: if isSignedIn() && (
        // Cardholder can read their own POs
        (isCardholder() && resource.data.cardholder.id == request.auth.uid) ||
        // Admin can read all POs
        isAdmin() ||
        // Requester can read POs for their requests
        (isRequester() && resource.data.reqId != null)
      );
      allow update: if isSignedIn() && (
        // Cardholder can update their own POs
        (isCardholder() && resource.data.cardholder.id == request.auth.uid) ||
        // Admin can update all POs
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Attachments collection
    match /attachments/{attachmentId} {
      allow create, read: if isSignedIn();
      allow delete: if isAdmin();
    }
    
    // Cycles collection
    match /cycles/{cycleId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isCardholder();
    }
    
    // Audit collection (immutable)
    match /audit/{eventId} {
      allow read: if isAuditor() || isAdmin();
      allow create: if false; // Only server-side functions can create
      allow update, delete: if false; // Immutable
    }
    
    // Audit Packages collection
    match /auditPackages/{packageId} {
      allow read: if isAuditor() || isAdmin();
      allow create: if isAuditor() || isAdmin();
      allow update: if isAuditor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Audit Package Exports collection
    match /auditExports/{exportId} {
      allow read: if isAuditor() || isAdmin();
      allow create: if isAuditor() || isAdmin();
      allow update: if isAuditor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Compliance Checks collection
    match /complianceChecks/{checkId} {
      allow read: if isAuditor() || isAdmin();
      allow create: if isAuditor() || isAdmin();
      allow update: if isAuditor() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn(); // Server-side functions can create
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Notification preferences collection
    match /notificationPreferences/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Messages collection
    match /messages/{messageId} {
      allow read: if isSignedIn() && (
        // User can read messages they sent or received
        resource.data.senderId == request.auth.uid || 
        resource.data.recipientId == request.auth.uid ||
        // Or if they're a participant in a thread
        request.auth.uid in resource.data.participants
      );
      allow create: if isSignedIn() && (
        // User can only send messages as themselves
        resource.data.senderId == request.auth.uid
      );
      allow update: if isSignedIn() && (
        // User can update their own messages (for read status, etc.)
        resource.data.senderId == request.auth.uid ||
        // Or if they're a participant in the thread
        request.auth.uid in resource.data.participants
      );
      allow delete: if isSignedIn() && (
        // User can delete their own messages
        resource.data.senderId == request.auth.uid ||
        // Admin can delete any message
        isAdmin()
      );
    }
    
    // Message Threads collection
    match /messageThreads/{threadId} {
      allow read: if isSignedIn() && (
        // User can read threads they participate in
        request.auth.uid in resource.data.participants ||
        // Admin can read all threads
        isAdmin()
      );
      allow create: if isSignedIn() && (
        // User can create threads they participate in
        request.auth.uid in resource.data.participants
      );
      allow update: if isSignedIn() && (
        // User can update threads they participate in
        request.auth.uid in resource.data.participants ||
        // Admin can update any thread
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        // User can delete threads they participate in
        request.auth.uid in resource.data.participants ||
        // Admin can delete any thread
        isAdmin()
      );
    }
    
    // Message Attachments collection
    match /messageAttachments/{attachmentId} {
      allow read: if isSignedIn() && (
        // User can read attachments from messages they have access to
        request.auth.uid in resource.data.participants ||
        // Admin can read all attachments
        isAdmin()
      );
      allow create: if isSignedIn() && (
        // User can create attachments for messages they're sending
        resource.data.senderId == request.auth.uid
      );
      allow update: if isSignedIn() && (
        // User can update their own attachments
        resource.data.senderId == request.auth.uid ||
        // Admin can update any attachment
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        // User can delete their own attachments
        resource.data.senderId == request.auth.uid ||
        // Admin can delete any attachment
        isAdmin()
      );
    }
    
    // Message Read Status collection
    match /messageReadStatus/{statusId} {
      allow read: if isSignedIn() && (
        // User can read their own read status
        resource.data.userId == request.auth.uid ||
        // Admin can read all read status
        isAdmin()
      );
      allow create: if isSignedIn() && (
        // User can create their own read status
        resource.data.userId == request.auth.uid
      );
      allow update: if isSignedIn() && (
        // User can update their own read status
        resource.data.userId == request.auth.uid ||
        // Admin can update any read status
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        // User can delete their own read status
        resource.data.userId == request.auth.uid ||
        // Admin can delete any read status
        isAdmin()
      );
    }
  }
}
