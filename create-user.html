<!doctype html>
<html>
  <head>
    <title>Create User Document</title>
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
      } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyB2LeC0_Zewi_DWdGqD7HjlqrsYypo7TnE',
        authDomain: 'procureflow-demo.firebaseapp.com',
        projectId: 'procureflow-demo',
        storageBucket: 'procureflow-demo.firebasestorage.app',
        messagingSenderId: '140102454715',
        appId: '1:140102454715:web:13d55b4d495db8a7fd089e',
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, async user => {
        if (user) {
          console.log('User authenticated:', user.uid, user.email);

          try {
            // Check if user document already exists
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
              console.log('User document already exists:', userSnap.data());
              document.getElementById('status').innerHTML =
                '✅ User document already exists!';
              document.getElementById('userData').innerHTML =
                '<pre>' + JSON.stringify(userSnap.data(), null, 2) + '</pre>';
            } else {
              console.log('Creating user document...');

              const userData = {
                name:
                  user.displayName || user.email.split('@')[0] || 'Admin User',
                email: user.email,
                role: 'admin',
                orgId: 'default-org',
                approvalLimit: 1000000,
                createdAt: new Date(),
                updatedAt: new Date(),
              };

              await setDoc(userRef, userData);
              console.log('User document created successfully!');

              document.getElementById('status').innerHTML =
                '✅ User document created successfully!';
              document.getElementById('userData').innerHTML =
                '<pre>' + JSON.stringify(userData, null, 2) + '</pre>';

              // Redirect to profile page after 3 seconds
              setTimeout(() => {
                window.location.href = '/profile';
              }, 3000);
            }
          } catch (error) {
            console.error('Error:', error);
            document.getElementById('status').innerHTML =
              '❌ Error: ' + error.message;
          }
        } else {
          console.log('No user authenticated');
          document.getElementById('status').innerHTML =
            '❌ No user authenticated. Please log in first.';
        }
      });
    </script>
  </head>
  <body>
    <h1>Create User Document</h1>
    <div id="status">Checking authentication...</div>
    <div id="userData"></div>
  </body>
</html>

